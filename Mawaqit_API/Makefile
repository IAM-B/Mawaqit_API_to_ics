# Variables
VENV := env-mawaqit
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip
APP := main:app
PORT := 8000

# âš™ï¸ CrÃ©ation de l'environnement virtuel + install des dÃ©pendances
install: $(VENV)/bin/activate

$(VENV)/bin/activate: requirements.txt
	@echo "ğŸ“¦ CrÃ©ation de lâ€™environnement virtuel..."
	python -m venv $(VENV)
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@touch $(VENV)/bin/activate
	@echo "âœ… DÃ©pendances installÃ©es."

# ğŸš€ Lancement de l'API en mode local
run: install
	@echo "ğŸš€ DÃ©marrage de lâ€™API avec Uvicorn..."
	$(VENV)/bin/uvicorn $(APP) --host 0.0.0.0 --port $(PORT)

# ğŸ³ Docker build + run
docker-build:
	@echo "ğŸ³ Construction de lâ€™image Docker..."
	docker build -t mawaqit-api .

docker-run:
	@echo "ğŸ³ Lancement du conteneur Docker..."
	docker run -d --name mawaqit-api -p $(PORT):80 mawaqit-api

# ğŸ§¼ Nettoyage
clean:
	@echo "ğŸ—‘ï¸ Suppression de lâ€™environnement virtuel..."
	rm -rf $(VENV)

docker-clean:
	docker rm -f mawaqit-api || true
	docker rmi mawaqit-api || true

reset: clean install

# â„¹ï¸ Aide
help:
	@echo ""
	@echo "Commandes disponibles :"
	@echo "  make install        â†’ Installer les dÃ©pendances Python"
	@echo "  make run            â†’ Lancer lâ€™API localement avec Uvicorn"
	@echo "  make docker-build   â†’ Construire lâ€™image Docker"
	@echo "  make docker-run     â†’ Lancer lâ€™API en conteneur Docker"
	@echo "  make clean          â†’ Supprimer lâ€™environnement virtuel"
	@echo "  make docker-clean   â†’ Supprimer le conteneur et lâ€™image Docker"
	@echo "  make reset          â†’ RecrÃ©er lâ€™environnement local"
	@echo ""
