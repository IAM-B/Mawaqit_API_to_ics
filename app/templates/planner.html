<!-- TEST-ID: planner-page -->
<!-- Planner Page Template - Synchronized Schedule -->
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>🕌 Planning synchronisé</title>
    <!-- Favicon and stylesheet links -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/clock.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}" />
    <!-- External CSS Libraries -->
    <!-- Tom Select for enhanced dropdowns -->
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css"
      rel="stylesheet"l
    />
    <!-- Leaflet for map functionality -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MarkerCluster for map markers -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <!-- Timeline JavaScript -->
    <script src="/static/js/clock.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/js/compact_map.js"></script>
  </head>
  <body class="page-transition">
    <main class="container">
      <!-- Main title -->
      <h1 class="page-title">🕌 Planning synchronisé</h1>

      <!-- Configuration Section (from index.html) -->
      <section class="config-section">
        
        <!-- Map container -->
        <div
          id="mosque-map"
          style="height: 400px; margin: 1em 0; border-radius: 8px"
        ></div>

        <!-- Main form for prayer planning -->
        <form class="form" id="plannerForm">
          <fieldset class="form-section">
            <h2>⚙️ Configuration</h2>
            <!-- Country selection -->
            <label for="country-select">Pays :</label>
            <select id="country-select" name="country" autocomplete="off">
              <option value="">-- Sélectionner un pays --</option>
            </select>

            <!-- Mosque selection -->
            <label for="mosque-select">Mosquée :</label>
            <select
              id="mosque-select"
              name="masjid_id"
              autocomplete="off"
              disabled
            >
              <option value="">-- Sélectionner une mosquée --</option>
            </select>

            <!-- Prayer time padding settings -->
            <label for="padding_before">Temps avant prière (min) :</label>
            <input type="number" name="padding_before" value="10" min="0" />

            <label for="padding_after">Temps après prière (min) :</label>
            <input type="number" name="padding_after" value="35" min="0" />

            <!-- Hidden fields for mosque coordinates -->
            <input type="hidden" id="mosque_lat" name="mosque_lat" value="" />
            <input type="hidden" id="mosque_lng" name="mosque_lng" value="" />
            <input type="hidden" id="mosque_name" name="mosque_name" value="" />
            <input type="hidden" id="mosque_address" name="mosque_address" value="" />

            <!-- Time scope selection -->
            <label for="scope">Période :</label>
            <select name="scope" required>
              <option value="today">Aujourd'hui</option>
              <option value="month">Mois</option>
              <option value="year">Année</option>
            </select>
          </fieldset>

          <!-- Submit button -->
          <button type="submit" class="btn-submit" aria-label="Générer planning">
            📥 Générer planning
          </button>
        </form>
      </section>

      {% if segments %}
      <!-- Quick actions section - Most important for user -->
      <section class="quick-actions" style="display: none;">
        <h2>📥 Téléchargements rapides</h2>
        <div class="download-grid">
          {% if ics_path %}
          <a href="{{ url_for('static', filename='ics/' + ics_path) }}" download class="download-card primary">
            <span class="download-icon">📅</span>
            <span class="download-title">Horaires de prière</span>
            <span class="download-format">.ics</span>
          </a>
          {% endif %}
          
          {% if available_slots_path %}
          <a href="{{ url_for('static', filename='ics/' + available_slots_path) }}" download class="download-card secondary">
            <span class="download-icon">🕒</span>
            <span class="download-title">Créneaux synchronisés</span>
            <span class="download-format">.ics</span>
          </a>
          {% endif %}
          
          {% if empty_slots_path %}
          <a href="{{ url_for('static', filename='ics/' + empty_slots_path) }}" download class="download-card secondary">
            <span class="download-icon">📋</span>
            <span class="download-title">Créneaux disponibles</span>
            <span class="download-format">.ics</span>
          </a>
          {% endif %}
          
          <!-- Manual editing card -->
          <a href="/edit_slot" class="download-card edit">
            <span class="download-icon">✏️</span>
            <span class="download-title">Modifier manuellement</span>
            <span class="download-format">Créneaux</span>
          </a>
        </div>
      </section>

      <!-- Interactive clock section - ALWAYS VISIBLE -->
      <section class="clock-section" style="display: none;">
        <h2>🕒 Horloge des prières</h2>
        <div class="clock-navigation">
          <button id="prevBtn" class="clock-nav-btn">←</button>
          <span id="currentDate" class="current-date"></span>
          <button id="nextBtn" class="clock-nav-btn">→</button>
        </div>
        <div id="clockContent" class="clock-container">
          <!-- Clock will be rendered here -->
        </div>
      </section>

      <!-- Available slots section -->
      <section class="available-slots" style="display: none;">
        <!-- TEST-ICI-MON-CALENDRIER -->
        <h2>📅 Vue calendrier</h2>
        
        <!-- Month Calendar View (Google Calendar style) -->
        <div id="monthCalendarView" class="calendar-view month-view" style="display: none;">
          <div class="calendar-header">
            <button id="prevMonthBtn" class="calendar-nav-btn">←</button>
            <h3 id="currentMonthTitle" class="calendar-title"></h3>
            <button id="nextMonthBtn" class="calendar-nav-btn">→</button>
          </div>
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <div class="weekday">Lun</div>
              <div class="weekday">Mar</div>
              <div class="weekday">Mer</div>
              <div class="weekday">Jeu</div>
              <div class="weekday">Ven</div>
              <div class="weekday">Sam</div>
              <div class="weekday">Dim</div>
            </div>
            <div id="monthCalendarDays" class="calendar-days">
              <!-- Calendar days will be generated here -->
            </div>
          </div>
        </div>

        <!-- Year Calendar View (Phone calendar style) -->
        <div id="yearCalendarView" class="calendar-view year-view" style="display: none;">
          <div class="year-header">
            <button id="prevYearBtn" class="calendar-nav-btn">←</button>
            <h3 id="currentYearTitle" class="calendar-title"></h3>
            <button id="nextYearBtn" class="calendar-nav-btn">→</button>
          </div>
          <div id="yearMonthsGrid" class="year-months-grid">
            <!-- Months will be generated here -->
          </div>
        </div>

        <!-- Default slots list (for today scope) -->
        <div id="defaultSlotsView" class="slots-view">
          <div id="availableSlotsList" class="slots-list">
            <!-- Slots will be displayed here dynamically -->
          </div>
        </div>
      </section>

      <!-- Mosque and configuration summary -->
      <section class="summary-section" style="display: none;">
        <div class="summary-grid">
          <!-- Mosque information -->
          <div class="summary-card mosque-info">
            <h3>🕌 Mosquée sélectionnée</h3>
            <div class="mosque-details">
              <h4>{{ mosque_name }}</h4>
              {% if mosque_address %}
              <p class="address">{{ mosque_address }}</p>
              {% endif %}
              
              <!-- Compact map container -->
              <div id="mosque-location-map" 
                   class="compact-map"
                   {% if mosque_lat and mosque_lng %}
                   data-lat="{{ mosque_lat }}"
                   data-lng="{{ mosque_lng }}"
                   data-name="{{ mosque_name }}"
                   {% endif %}>
              </div>
              
              <!-- Map links -->
              <div class="map-links">
                <a href="{{ google_maps_url }}" target="_blank" class="map-link">
                  🗺️ Google Maps
                </a>
                <a href="{{ osm_url }}" target="_blank" class="map-link">
                  🗺️ OpenStreetMap
                </a>
                <a href="{{ mawaqit_url }}" target="_blank" class="map-link">
                  🌐 Mawaqit.net
                </a>
              </div>
            </div>
          </div>

          <!-- Configuration summary -->
          <div class="summary-card config-info">
            <h3>⚙️ Configuration</h3>
            <div class="config-details">
              <div class="config-item">
                <span class="config-label">📅 Période :</span>
                <span class="config-value">{{ start_date }} → {{ end_date }}</span>
              </div>
              <div class="config-item">
                <span class="config-label">⏰ Délai avant :</span>
                <span class="config-value">{{ padding_before }} min</span>
              </div>
              <div class="config-item">
                <span class="config-label">⏰ Délai après :</span>
                <span class="config-value">{{ padding_after }} min</span>
              </div>
              <div class="config-item">
                <span class="config-label">🌍 Fuseau horaire :</span>
                <span class="config-value">{{ timezone_str }}</span>
              </div>
              <div class="config-item">
                <span class="config-label">📊 Portée :</span>
                <span class="config-value">{{ scope_display }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      {% else %}
      <!-- No data message -->
      <section class="no-data" style="display: none;">
        <div class="no-data-content">
          <h2>📭 Aucun créneau disponible</h2>
          <p>Aucun créneau disponible détecté pour la période sélectionnée.</p>
          <a href="/" class="back-button">← Retour à la sélection</a>
        </div>
      </section>
      {% endif %}

      <!-- Hidden configuration for clock -->
      {% if segments %}
      <div id="clockConfig" 
           data-segments='{{ segments|tojson|safe }}'
           data-scope="{{ scope }}"
           style="display: none;">
      </div>
      {% endif %}
    </main>

    <!-- External JavaScript Libraries -->
    <!-- Leaflet for map functionality -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MarkerCluster for map markers -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Tom Select for enhanced dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    
    <!-- Local JavaScript files -->
    <script src="{{ url_for('static', filename='js/mosque_search.js') }}"></script>
    <script src="{{ url_for('static', filename='js/map_loader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/planner.js') }}"></script>
    <script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
  </body>
</html>
