<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>üïå Planning synchronis√©</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="/static/js/timeline.js"></script>
  </head>
  <body>
    <main class="container">
      <h1 class="page-title">üïå Emploi du temps synchronis√©</h1>

      <section class="form">
        <fieldset class="form-section">
          <legend>üìå Informations G√©n√©rales</legend>

          <label>Fuseau horaire d√©tect√© :</label>
          <ul>
            <li>{{ timezone_str }}</li>
          </ul>

          {% if segments %}
          <div class="timeline-date" id="currentDate">
            {% if scope == "today" %}
              {{ segments.date if segments.date else "Aujourd'hui" }}
            {% elif scope == "month" %}
              {{ segments[0].date if segments[0].date else "Jour " + segments[0].day|string }}
            {% elif scope == "year" %}
              {{ segments[0].date if segments[0].date else "Mois " + segments[0].month|string }}
            {% endif %}
          </div>

          {% if scope != "today" %}
          <div class="timeline-navigation">
            <button class="timeline-nav-btn" id="prevBtn" onclick="navigate(-1)">‚Üê Pr√©c√©dent</button>
            <button class="timeline-nav-btn" id="nextBtn" onclick="navigate(1)">Suivant ‚Üí</button>
          </div>
          {% endif %}

          <div class="timeline-container">
            <div class="timeline-hours">
              {% for hour in range(24) %}
              <div class="timeline-hour">{{ hour }}h</div>
              {% endfor %}
            </div>
            <div class="timeline-content" id="timelineContent">
              <!-- Events will be added here dynamically -->
            </div>
          </div>

          <!-- Store data in data attributes -->
          <div id="timelineConfig" 
               data-segments='{{ segments|tojson|safe }}'
               data-scope="{{ scope }}"
               style="display: none;">
          </div>

          <script>
            // Initialize timeline once the DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
              const config = document.getElementById('timelineConfig');
              const timelineData = JSON.parse(config.dataset.segments);
              const timelineScope = config.dataset.scope;

              window.timeline = new Timeline(
                'timelineContent',
                timelineData,
                timelineScope
              );
            });

            // Navigation function
            function navigate(direction) {
              window.timeline.navigate(direction);
            }
          </script>

          <label>Cr√©neaux disponibles :</label>
          <ul>
            {% if scope == "today" %}
              <li>
                <strong>{{ segments.date if segments.date else "Aujourd'hui" }} :</strong>
                <ul>
                  {% for seg in segments.slots %}
                  <li>{{ seg.start }} - {{ seg.end }}</li>
                  {% endfor %}
                </ul>
              </li>
            {% elif scope == "month" %}
              {% for day in segments %}
              <li>
                <strong>{{ day.date if day.date else "Jour " + day.day|string }} :</strong>
                <ul>
                  {% for slot in day.slots %}
                  <li>{{ slot.start }} - {{ slot.end }}</li>
                  {% endfor %}
                </ul>
              </li>
              {% endfor %}
            {% elif scope == "year" %}
              {% for month in segments %}
              <li>
                <strong>{{ month.date if month.date else "Mois " + month.month|string }} :</strong>
                <ul>
                  {% for day in month.days %}
                  <li>
                    <strong>{{ day.date if day.date else "Jour " + day.day|string }} :</strong>
                    <ul>
                      {% for slot in day.slots %}
                      <li>{{ slot.start }} - {{ slot.end }}</li>
                      {% endfor %}
                    </ul>
                  </li>
                  {% endfor %}
                </ul>
              </li>
              {% endfor %}
            {% endif %}
          </ul>
          {% else %}
          <p>Aucun cr√©neau disponible d√©tect√© pour la p√©riode s√©lectionn√©e.</p>
          {% endif %}

          <boutton class="btn-submit">
            <a href="/edit_slot">‚úèÔ∏è Modifier un cr√©neau manuellement</a>
          </boutton>
          
        </fieldset>

        <fieldset class="form-section">
          <legend>üìÇ Fichiers t√©l√©chargeables</legend>

          {% if ics_path %}
          <boutton class="btn-submit"
            ><a href="{{ url_for('static', filename='ics/' + ics_path) }}" download
              >üì• T√©l√©charger les horaires de pri√®re (.ics)</a
            ></boutton
          >
          {% endif %} 
          {% if empty_slots_path %}
          <boutton class="btn-submit"
            ><a href="{{ url_for('static', filename='ics/' + empty_slots_path) }}" download
              >üì• T√©l√©charger les cr√©neaux disponibles (.ics)</a
            ></boutton
          >
          {% endif %} 
          {% if available_slots_path %}
          <boutton class="btn-submit"
            ><a href="{{ url_for('static', filename='ics/' + available_slots_path) }}" download
              >üì• T√©l√©charger les cr√©neaux synchronis√©s (.ics)</a
            ></boutton
          >
          {% endif %}
        </fieldset>
      </section>
    </main>
  </body>
</html>
